#!/usr/bin/env bash

set -e

# Ensure $HOME exists
if [ -z "$HOME" ]; then
    echo "HOME variable not set!";
    exit 1;
fi

# Definitions
AUTHOR="NikoboiNFTB"
ROOT_DIR="$HOME/GitHub"
AUTHOR_DIR="$HOME/GitHub/$AUTHOR"
mkdir -p "$AUTHOR_DIR"
cd "$AUTHOR_DIR"

# Ensure jq is installed
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required but not installed."
    exit 1
fi

# Get repo names
echo "Fetching list of repositories for user '$AUTHOR'..."
repos=$(curl -s "https://api.github.com/users/$AUTHOR/repos?per_page=100" | jq -r '.[].name')
if [ -z "$repos" ]; then
    echo "No repositories found or failed to fetch from GitHub."
    exit 1
fi
echo
echo "Found $(echo "$repos" | wc -w) repositories. Cloning/pulling all..."
echo

# Clone
for repo in $repos; do
    (
        if [ -d "$repo/.git" ]; then
            echo "Updating $repo..."
            cd "$repo" && git pull --quiet || echo "Pulling $repo failed"
        else
            echo "Cloning $repo..."
            git clone --quiet "git@github.com:$AUTHOR/$repo.git" || echo "Cloning $repo failed"
        fi
    ) &
done

wait

echo
echo "All clone/update tasks completed!"
echo

# Copy all files to correct directories
echo "Copying files..."

for file in $AUTHOR_DIR/GitHub-Tools/shell/git/bulk/*; do
    cp "$file" "$AUTHOR_DIR/"
done
for file in $AUTHOR_DIR/GitHub-Tools/shell/git/clone/*; do
    cp "$file" "$ROOT_DIR/"
done
for file in $AUTHOR_DIR/GitHub-Tools/shell/git/repo/*; do
    cp "$file" "$AUTHOR_DIR/"
done
for file in $AUTHOR_DIR/GitHub-Tools/shell/git/ssh/*; do
    cp "$file" "$AUTHOR_DIR/"
done

# Give executable permissions
chmod +x "$AUTHOR_DIR"/* "$ROOT_DIR"/*

echo "Files copied!"

# Prompt to hide SSH scripts (y/N)
echo
read -p "Hide SSH scripts? (y/N): " hide_ssh

if [[ "$hide_ssh" =~ ^[yY]$ ]]; then
    # Hide the SSH scripts
    mv "$AUTHOR_DIR/disable-ssh" "$AUTHOR_DIR/.disable-ssh"
    mv "$AUTHOR_DIR/enable-ssh" "$AUTHOR_DIR/.enable-ssh"
    echo "SSH scripts hidden."
else
    # Remove hidden scripts if they exist
    rm -f "$AUTHOR_DIR/.disable-ssh" "$AUTHOR_DIR/.enable-ssh"
    echo "SSH scripts not hidden."
fi

# Reset */.git/info/exclude
# bash $AUTHOR_DIR/ignore-reset

# Add automation/ to */.git/info/exclude
FILES=(automation automation/ automation/pull automation/push automation/status)
added=false

for FILE_NAME in "${FILES[@]}"; do
    for f in */.git/info/exclude; do
        if ! grep -qxF "$FILE_NAME" "$f"; then
            echo "$FILE_NAME" >> "$f"
            added=true
        fi
    done
done

# Add automation/ to repos
mkdir -p automation
cp pull push status automation/ || echo "Failed to copy scripts into automation/"

for d in */; do
    if [ "$d" != "automation/" ]; then
        cp -r automation "$d" || echo "Failed to copy automation to $d"
    fi
done

rm -rf automation || echo "Failed to remove temporary automation folder"








# Hang

KEEP_OPEN=true

if [ "$KEEP_OPEN" = true ]; then
    echo
    read -p "Press 'Enter' to exit / Type 'disable' to disable hanging: " response
    if [ "$response" = "disable" ]; then
        sed -i 's/^KEEP_OPEN=true/KEEP_OPEN=false/' "$0"
        echo
        echo "KEEP_OPEN set to false"
        echo "Change 'KEEP_OPEN=true' to enable"
        sleep 4
    fi
fi
