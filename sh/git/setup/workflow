#!/usr/bin/env bash

set -e

# Definitions
AUTHOR="NikoboiNFTB"
ROOT_DIR="$HOME/GitHub"
AUTHOR_DIR="$HOME/GitHub/$AUTHOR"
mkdir -p "$AUTHOR_DIR"
cd "$AUTHOR_DIR"

# Ensure jq is installed
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required but not installed."
    exit 1
fi

# Get repo names
echo "Fetching list of repositories for user '$AUTHOR'..."
repos=$(curl -s "https://api.github.com/users/$AUTHOR/repos?per_page=100" | jq -r '.[].name')
if [ -z "$repos" ]; then
    echo "No repositories found or failed to fetch from GitHub."
    exit 1
fi
echo "Found $(echo "$repos" | wc -w) repositories. Cloning/pulling all in parallel..."

# Clone
for repo in $repos; do
    (
        if [ -d "$repo/.git" ]; then
            echo "Updating $repo..."
            cd "$repo" && git pull --quiet
        else
            echo "Cloning $repo..."
            git clone --quiet "git@github.com:$AUTHOR/$repo.git"
        fi
    ) &
done

wait

echo "All clone/update tasks completed!"

# Copy all files to correct directories
echo "Copying files..."

for file in GitHub-Tools/shell/git/bulk/*; do
    cp "$file" "$AUTHOR_DIR/"
done
for file in GitHub-Tools/shell/git/clone/*; do
    cp "$file" "$ROOT_DIR/"
done
for file in GitHub-Tools/shell/git/repo/*; do
    cp "$file" "$AUTHOR_DIR/"
done
for file in GitHub-Tools/shell/git/ssh/*; do
    cp "$file" "$AUTHOR_DIR/"
done

# Ensure only copied files get executable permissions
chmod +x "$AUTHOR_DIR"/* "$ROOT_DIR"/*

echo "Files copied!"

# Prompt to hide SSH scripts (y/N)
read -p "Hide SSH scripts? (y/N): " hide_ssh

if [[ "$hide_ssh" =~ ^[yY]$ ]]; then
    # Hide the SSH scripts
    mv "$AUTHOR_DIR/disable-ssh" "$AUTHOR_DIR/.disable-ssh"
    mv "$AUTHOR_DIR/enable-ssh" "$AUTHOR_DIR/.enable-ssh"
    echo "SSH scripts hidden."
else
    # Remove hidden scripts if they exist
    rm -f "$AUTHOR_DIR/.disable-ssh" "$AUTHOR_DIR/.enable-ssh"
    echo "SSH scripts not hidden."
fi
