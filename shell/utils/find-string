#!/usr/bin/env bash

set -e

# Variables to hold search string, targets, and ignored paths
search_string=""
targets=()
ignore=()

# --- Parse command-line arguments ---
while [[ $# -gt 0 ]]; do
    case "$1" in
        -i|--ignore)
            shift
            while [[ $# -gt 0 && ! "$1" =~ ^- ]]; do
                ignore+=("$1")
                shift
            done
            ;;
        *)
            if [[ -z "$search_string" ]]; then
                search_string="$1"
            else
                targets+=("$1")
            fi
            shift
            ;;
    esac
done

# --- Prompt for search string if missing ---
if [[ -z "$search_string" ]]; then
    read -rp "Text to search for: " search_string
    # Remove surrounding quotes if present
    if [[ "$search_string" =~ ^\"(.*)\"$ ]]; then
        search_string="${BASH_REMATCH[1]}"
    elif [[ "$search_string" =~ ^\'(.*)\'$ ]]; then
        search_string="${BASH_REMATCH[1]}"
    fi
fi

# --- Default targets to . if none provided ---
if [[ ${#targets[@]} -eq 0 ]]; then
    targets=(".")
fi

# --- Prompt for ignore paths if none provided via CLI ---
if [[ ${#ignore[@]} -eq 0 ]]; then
    read -rp "Files/directories to ignore (space-separated, optional): " ignore_input
    # Split input into array
    if [[ -n "$ignore_input" ]]; then
        # Handle quoted paths: remove surrounding quotes
        for item in $ignore_input; do
            if [[ "$item" =~ ^\"(.*)\"$ ]]; then
                ignore+=("${BASH_REMATCH[1]}")
            elif [[ "$item" =~ ^\'(.*)\'$ ]]; then
                ignore+=("${BASH_REMATCH[1]}")
            else
                ignore+=("$item")
            fi
        done
    fi
fi

# --- Build find command ---
cmd=(find "${targets[@]}")

# Exclude ignored directories/files
if [[ ${#ignore[@]} -gt 0 ]]; then
    prune_expr=()
    for ign in "${ignore[@]}"; do
        prune_expr+=(-name "$ign" -prune -o)
    done
    cmd+=("${prune_expr[@]}")
fi

# Always search files
cmd+=(-type f -print)

# --- Execute find and search content ---
"${cmd[@]}" 2>/dev/null | xargs grep -Hn -- "$search_string" 2>/dev/null
