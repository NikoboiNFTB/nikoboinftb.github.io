#!/usr/bin/env bash

set -euo pipefail

# This is used for the Hang at the end, for disabling it.
SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")

SSH_DIR="$HOME/.ssh"
KEY_FILE="$SSH_DIR/id_ed25519"
PUB_KEY_FILE="$KEY_FILE.pub"

# Helpers
die() { echo "❌ $1" >&2; exit 1; }
info() { echo "ℹ️  $1"; }
ok() { echo "✅ $1"; }

info "Running preflight checks..."

# Check HOME
[[ -n "$HOME" ]] || die "HOME variable not set."
ok "HOME exists: $HOME"

# Check required commands
for cmd in git ssh ssh-keygen ssh-add; do
    command -v "$cmd" >/dev/null || die "$cmd is required but not installed."
    ok "$cmd found"
done

# Ensure .ssh directory exists
mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"
ok ".ssh directory exists with proper permissions"

# Generate SSH key if missing
if [[ ! -f "$KEY_FILE" ]]; then
    info "No SSH key found. Generating id_ed25519..."
    read -rp "Enter a comment for the SSH key (optional, press ENTER to skip): " KEY_COMMENT
    ssh-keygen -t ed25519 -f "$KEY_FILE" -N "" -C "$KEY_COMMENT"
fi

# Set correct permissions
chmod 600 "$KEY_FILE"
chmod 644 "$PUB_KEY_FILE"
ok "SSH key files exist with correct permissions"

# Start ssh-agent if needed
if [[ -z "${SSH_AUTH_SOCK:-}" ]]; then
    info "Starting ssh-agent..."
    eval "$(ssh-agent -s)"
fi
ok "SSH agent running"

# Ensure key is loaded in agent
if ! ssh-add -l | grep -q "$(ssh-keygen -lf "$KEY_FILE" | awk '{print $2}')"; then
    info "Adding key to ssh-agent..."
    ssh-add "$KEY_FILE" || die "Failed to add SSH key to agent"
fi
ok "SSH key loaded into agent"

# Test GitHub SSH connectivity
SSH_TEST_OUTPUT="$(ssh -T git@github.com 2>&1 || true)"
if echo "$SSH_TEST_OUTPUT" | grep -Eq "successfully authenticated|Hi "; then
    ok "GitHub SSH authentication works"
else
    echo "$SSH_TEST_OUTPUT"
    die "SSH authentication to GitHub failed. Add your public key to GitHub."
fi

# Print the public key
echo
info "================ SSH PUBLIC KEY ================"
echo
cat "$PUB_KEY_FILE"
echo
info "================================================"
echo

# GitHub instructions
echo "1. Triple-click the key above and copy it."
echo "2. Add it to GitHub: https://github.com/settings/ssh/new"
echo "   - Give it a Title"
echo "   - Leave 'Key Type' as 'Authentication Key'"
echo "   - Paste the key"
echo "3. After adding, press ENTER to continue..."
read -rp ""

# Test SSH connection to GitHub interactively
info "Testing GitHub SSH connection..."
echo
ssh -T git@github.com || true
echo
ok "Git + SSH setup complete"
info "You can now run my other scripts for full PC git setup:"
echo "   bash <(wget -qO- https://nikoboinftb.github.io/shell/git/setup/automation)"

# Hang

KEEP_OPEN=true

if [ "$KEEP_OPEN" = true ]; then
    echo
    read -p "Press 'Enter' to exit / Type 'disable' to disable hanging (local only): " response
    if [ "$response" = "disable" ]; then
        sed -i 's/^KEEP_OPEN=true/KEEP_OPEN=false/' "$SCRIPT_PATH"
        echo
        echo "KEEP_OPEN set to false"
        echo "Change 'KEEP_OPEN=true' to enable"
        echo
        for i in {5..1}; do
            echo -n "Exiting in $i..."
            sleep 1
            echo -ne "\r"
        done
        echo "Exiting now.        "
    fi
fi
